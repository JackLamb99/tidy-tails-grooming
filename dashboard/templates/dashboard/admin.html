{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container my-4">
    <h1 class="mb-4">Admin Dashboard</h1>

    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.level_tag }} alert-dismissible fade show" role="alert"
            data-autohide="true" data-delay="2000">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    {% endif %}

    <!-- Accordion wrapper -->
    <div class="accordion" id="adminAccordion">

        <!-- Services (Item 1) -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingServices">
                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseServices" aria-expanded="true" aria-controls="collapseServices">
                    Services
                </button>
            </h2>
            <div id="collapseServices" class="accordion-collapse collapse show" aria-labelledby="headingServices" data-bs-parent="#adminAccordion">
                <div class="accordion-body">

                    <section class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h3 class="mb-0">Services</h3>
                            <button
                                type="button"
                                class="btn btn-sm btn-primary"
                                data-bs-toggle="modal"
                                data-bs-target="#serviceFormModal"
                                data-load-url="{% url 'dashboard:service_new' %}">
                                New Service
                            </button>
                        </div>
                        <ul class="list-group">
                            {% for s in services %}
                                <li class="list-group-item d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
                                    <span>{{ s.name }}</span>
                                    <div class="d-flex gap-2">
                                        {% if s.is_active %}
                                            <span class="badge bg-success align-self-center">Active</span>
                                        {% else %}
                                            <span class="badge bg-secondary align-self-center">Inactive</span>
                                        {% endif %}
                                        <form method="post" action="{% url 'dashboard:service_toggle' s.pk %}">
                                            {% csrf_token %}
                                            {% if s.is_active %}
                                                <button class="btn btn-sm btn-outline-secondary" type="submit">Set Inactive</button>
                                            {% else %}
                                                <button class="btn btn-sm btn-outline-success" type="submit">Set Active</button>
                                            {% endif %}
                                        </form>
                                        <!-- Edit service -->
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-primary"
                                            data-bs-toggle="modal"
                                            data-bs-target="#serviceFormModal"
                                            data-load-url="{% url 'dashboard:service_edit' s.pk %}">
                                            Edit
                                        </button>
                                        {% if not s.is_active and s.confirmed_count == 0 %}
                                            <button
                                                type="button"
                                                class="btn btn-sm btn-outline-danger"
                                                data-bs-toggle="modal"
                                                data-bs-target="#confirmActionModal"
                                                data-action-url="{% url 'dashboard:service_delete' s.pk %}"
                                                data-action-title="Delete Service"
                                                data-action-text="Are you sure you want to delete this service?"
                                                data-action-label="{{ s.name }} (all existing bookings will keep their history)"
                                                data-action-btn-class="btn-danger"
                                                data-action-btn-text="Yes, delete it">
                                                Delete
                                            </button>
                                        {% endif %}
                                    </div>
                                </li>
                            {% empty %}
                                <li class="list-group-item text-muted">No services yet.</li>
                            {% endfor %}
                        </ul>
                    </section>

                </div>
            </div>
        </div>

        <!-- Bookings (Item 2) -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingBookings">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseBookings" aria-expanded="false" aria-controls="collapseBookings">
                    Bookings
                </button>
            </h2>
            <div id="collapseBookings" class="accordion-collapse collapse" aria-labelledby="headingBookings" data-bs-parent="#adminAccordion">
                <div class="accordion-body">

                    <section class="mb-4">
                        <h3>Bookings - Upcoming</h3>
                        <ul class="list-group">
                            {% for b in upcoming %}
                                <li class="list-group-item d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
                                    <div>
                                        {{ b.date }} @ {{ b.time|time:"H:i" }} - {{ b.get_service_display_name }}
                                    </div>
                                    <div class="d-flex gap-2">
                                        <!-- View booking details -->
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-primary"
                                            data-bs-toggle="modal"
                                            data-bs-target="#viewModal"
                                            data-load-url="{% url 'dashboard:booking_view' b.pk %}">
                                            View
                                        </button>
                                        <!-- Mark booking as completed -->
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-success"
                                            data-bs-toggle="modal"
                                            data-bs-target="#confirmActionModal"
                                            data-action-url="{% url 'dashboard:booking_complete' b.pk %}"
                                            data-action-title="Mark Booking as Completed"
                                            data-action-text="Are you sure you want to mark this booking as completed?"
                                            data-action-label="{{ b.date }} @ {{ b.time|time:'H:i' }} - {{ b.get_service_display_name }}"
                                            data-action-btn-class="btn-outline-success"
                                            data-action-btn-text="Yes, mark completed">
                                            Complete
                                        </button>
                                        <!-- Cancel booking -->
                                        <button
                                            type="button"
                                            class="btn btn-sm btn-outline-danger"
                                            data-bs-toggle="modal"
                                            data-bs-target="#confirmActionModal"
                                            data-action-url="{% url 'dashboard:booking_cancel' b.pk %}"
                                            data-action-title="Cancel Booking"
                                            data-action-text="Are you sure you want to cancel this booking?"
                                            data-action-label="{{ b.date }} @ {{ b.time|time:'H:i' }} - {{ b.get_service_display_name }}"
                                            data-action-btn-class="btn-danger"
                                            data-action-btn-text="Yes, cancel it">
                                            Cancel
                                        </button>
                                    </div>
                                </li>
                            {% empty %}
                                <li class="list-group-item text-muted">No upcoming bookings.</li>
                            {% endfor %}
                        </ul>

                        <h3 class="mt-4">Bookings - Completed or Cancelled</h3>
                        <ul class="list-group">
                            {% for b in previous %}
                                <li class="list-group-item d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
                                    {{ b.date }} @ {{ b.time|time:"H:i" }} - {{ b.get_service_display_name }}
                                    {% if b.status == 'completed' %}
                                        <span class="badge bg-success align-self-center">Completed</span>
                                    {% elif b.status == 'cancelled' %}
                                        <span class="badge bg-danger align-self-center">Cancelled</span>
                                    {% endif %}
                                </li>
                            {% empty %}
                                <li class="list-group-item text-muted">None yet.</li>
                            {% endfor %}
                        </ul>
                    </section>

                </div>
            </div>
        </div>

        <!-- Messages (Item 3) -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingMessages">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseMessages" aria-expanded="false" aria-controls="collapseMessages">
                    Messages
                </button>
            </h2>
            <div id="collapseMessages" class="accordion-collapse collapse" aria-labelledby="headingMessages" data-bs-parent="#adminAccordion">
                <div class="accordion-body">

                    <section class="mb-4">
                        <h3>Messages</h3>
                        <ul class="list-group">
                            {% for m in messages_qs %}
                                <li class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ m.email }}</strong> - {{ m.subject }}
                                            <div class="text-muted small">
                                                {{ m.created_at|date:"d M Y @ H:i" }}
                                            </div>
                                        </div>
                                        <form>
                                            <!-- View message details -->
                                            <button
                                                type="button"
                                                class="btn btn-sm btn-outline-primary"
                                                data-bs-toggle="modal"
                                                data-bs-target="#viewModal"
                                                data-load-url="{% url 'dashboard:message_view' m.pk %}">
                                                View
                                            </button>
                                            <!-- Delete message -->
                                            <button
                                                type="button"
                                                class="btn btn-sm btn-outline-danger"
                                                data-bs-toggle="modal"
                                                data-bs-target="#confirmActionModal"
                                                data-action-url="{% url 'dashboard:message_delete' m.pk %}"
                                                data-action-title="Delete Message"
                                                data-action-text="Are you sure you want to delete this message?"
                                                data-action-label="{{ m.email }} - {{ m.subject }}"
                                                data-action-btn-class="btn-danger"
                                                data-action-btn-text="Yes, delete it">
                                                Delete
                                            </button>
                                        </form>
                                    </div>
                                </li>
                            {% empty %}
                                <li class="list-group-item text-muted">No messages.</li>
                            {% endfor %}
                        </ul>
                    </section>

                </div>
            </div>
        </div>

    </div>
</div>

<!-- Reusable confirmation modal -->
<div class="modal fade" id="confirmActionModal" tabindex="-1" aria-labelledby="confirmActionLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="confirmActionForm" method="post">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmActionLabel">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-2" id="confirmActionText">Are you sure?</p>
                    <p class="text-muted small mb-0" id="confirmActionMeta"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, keep it</button>
                    <button type="submit" id="confirmActionSubmit" class="btn">Confirm</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Service form modal (empty body, injects partial) -->
<div class="modal fade" id="serviceFormModal" tabindex="-1" aria-labelledby="serviceFormLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div id="serviceFormContainer">
                <!-- partial loads here -->
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="viewModal" tabindex="-1" aria-labelledby="viewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="viewModalContainer">
            <!-- partial loads here -->
        </div>
    </div>
</div>
{% endblock %}
